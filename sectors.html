<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise Setorial - B3 SmallCaps Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* ============================
           SECTORS.HTML - REDESIGN V3.0
           Dashboard interativo e data-driven
           ============================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0066cc;
            --success: #00c853;
            --danger: #f44336;
            --warning: #ff9800;
            --dark: #1a1a2e;
            --secondary-dark: #2c3e50;
            --card-bg: #2f4159;
            --text-light: #f0f4f8;
            --border: rgba(255,255,255,0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--secondary-dark) 100%);
            color: var(--text-light);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ==================== NAVIGATION ==================== */
        .main-nav {
            background: var(--dark);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .nav-container {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
        }
        
        .nav-logo a {
            text-decoration: none;
            color: inherit;
            display: block;
            padding: 20px 0;
        }

        .logo-text {
            font-size: 1.5em;
            font-weight: 800;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .nav-links {
            display: flex;
            list-style: none;
            gap: 8px;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .nav-link:hover,
        .nav-link.active {
            background: rgba(0, 102, 204, 0.2);
            color: white;
        }

        /* ==================== HEADER ==================== */
        .page-header {
            background: linear-gradient(135deg, var(--primary) 0%, #0052a3 100%);
            color: white;
            padding: 50px 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header-content h1 {
            font-size: 2.5em;
            margin-bottom: 0px;
            font-weight: 800;
        }
        
        .header-content p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        /* ==================== CONTAINER ==================== */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }

        /* ==================== STATS DASHBOARD ==================== */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .stat-label {
            font-size: 0.85em;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-change {
            font-size: 0.9em;
            margin-top: 5px;
        }

        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }

        /* ==================== FILTERS SECTION ==================== */
        .filters-bar {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 0.85em;
            font-weight: 600;
            color: rgba(255,255,255,0.8);
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 12px;
            background: rgba(0,0,0,0.3);
            border: 2px solid var(--border);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 0.95em;
            transition: all 0.3s;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2);
        }

        .btn-filter {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-filter:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* ==================== SECTOR CARDS ==================== */
        .sectors-grid {
            display: grid;
            gap: 20px;
        }

        .sector-card {
            background: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .sector-card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .sector-header {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--primary);
            transition: all 0.3s;
        }

        .sector-header:hover {
            background: rgba(0,0,0,0.3);
        }

        .sector-header.active {
            background: rgba(0, 102, 204, 0.15);
        }

        .sector-title-group {
            flex: 1;
        }

        .sector-name {
            font-size: 1.4em;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }

        .sector-subtitle {
            font-size: 0.9em;
            color: rgba(255,255,255,0.6);
        }

        .sector-metrics {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        .metric-box {
            text-align: center;
        }

        .metric-box-label {
            font-size: 0.75em;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-box-value {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--primary);
        }

        .expand-icon {
            font-size: 1.5em;
            color: var(--primary);
            transition: transform 0.3s;
        }

        .sector-header.active .expand-icon {
            transform: rotate(180deg);
        }

        /* ==================== SECTOR BODY (COLLAPSIBLE) ==================== */
        .sector-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .sector-body.expanded {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }

        .sector-content {
            padding: 20px;
        }

        .sector-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .sector-stat-item {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .sector-stat-label {
            font-size: 0.8em;
            color: rgba(255,255,255,0.6);
            margin-bottom: 5px;
        }

        .sector-stat-value {
            font-size: 1.4em;
            font-weight: 700;
            color: white;
        }

        /* ==================== COMPANIES TABLE ==================== */
        .companies-table-container {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }

        .companies-table {
            width: 100%;
            border-collapse: collapse;
        }

        .companies-table thead {
            background: rgba(0,0,0,0.3);
        }

        .companies-table th {
            padding: 12px;
            text-align: left;
            font-size: 0.85em;
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .companies-table td {
            padding: 12px;
            border-top: 1px solid var(--border);
            font-size: 0.9em;
        }

        .companies-table tbody tr {
            transition: background 0.2s;
        }

        .companies-table tbody tr:hover {
            background: rgba(0, 102, 204, 0.1);
        }

        .ticker-cell {
            font-weight: 700;
            color: var(--primary);
        }

        .score-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.85em;
            display: inline-block;
        }

        .score-high { background: var(--success); color: white; }
        .score-medium { background: var(--warning); color: white; }
        .score-low { background: var(--danger); color: white; }

        .upside-positive { color: var(--success); font-weight: 600; }
        .upside-negative { color: var(--danger); font-weight: 600; }

        /* ==================== CHART SECTION ==================== */
        .chart-section {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .chart-section h4 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* ==================== TRENDS SECTION ==================== */
        .trends-section {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .trends-section h4 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .trends-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .trend-column {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 6px;
        }

        .trend-column.positive {
            border-left: 3px solid var(--success);
        }

        .trend-column.negative {
            border-left: 3px solid var(--danger);
        }

        .trend-column h5 {
            color: rgba(255,255,255,0.9);
            margin-bottom: 12px;
            font-size: 0.95em;
        }

        .trend-column ul {
            list-style: none;
            padding: 0;
        }

        .trend-column li {
            padding: 6px 0 6px 20px;
            font-size: 0.85em;
            color: rgba(255,255,255,0.8);
            position: relative;
            line-height: 1.5;
        }

        .trend-column.positive li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: var(--success);
            font-weight: 700;
        }

        .trend-column.negative li:before {
            content: "⚠";
            position: absolute;
            left: 0;
        }

        /* ==================== FOOTER ==================== */
        .footer {
            background: var(--dark);
            color: white;
            padding: 30px;
            margin-top: 0px;
            border-top: 2px solid var(--border);
            text-align: center;
        }

        .footer p {
            opacity: 0.8;
            margin-bottom: 5px;
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 1024px) {
            .sector-metrics {
                flex-wrap: wrap;
                gap: 15px;
            }

            .trends-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .header-content h1 {
                font-size: 1.8em;
            }

            .stats-dashboard {
                grid-template-columns: repeat(2, 1fr);
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .sector-metrics {
                display: none;
            }

            .companies-table {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="main-nav">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="index.html">
                    <span class="logo-text">SmallCaps B3</span>
                </a>
            </div>
            <ul class="nav-links">
                <li><a href="sectors.html" class="nav-link active">Setores</a></li>
                <li><a href="charts.html" class="nav-link">Gráficos</a></li>
                <li><a href="timeline.html" class="nav-link">Timeline</a></li>
            </ul>
        </div>
    </nav>

    <!-- Page Header -->
    <header class="page-header">
        <div class="header-content">
            <h1>Análise Setorial</h1>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container" style="margin-top: -60px;">
        
        <!-- Stats Dashboard -->
        <section class="stats-dashboard" id="stats-dashboard">
            <!-- Stats will be populated by JS -->
        </section>

        <!-- Filters Bar -->
        <section class="filters-bar">
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Ordenar por</label>
                    <select id="sort-by">
                        <option value="score">Score</option>
                        <option value="upside">Upside</option>
                        <option value="roe">ROE</option>
                        <option value="ytd">Performance YTD</option>
                        <option value="companies">Nº Empresas</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Filtrar por Score</label>
                    <select id="filter-score">
                        <option value="">Todos</option>
                        <option value="high">Alto (>75)</option>
                        <option value="medium">Médio (55-75)</option>
                        <option value="low">Baixo (<55)</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Buscar Setor</label>
                    <input type="text" id="search-sector" placeholder="Digite o nome...">
                </div>

                <div class="filter-group">
                    <button class="btn-filter" onclick="applyFilters()">Aplicar</button>
                </div>

                <div class="filter-group">
                    <button class="btn-filter" onclick="expandAll()" style="background: rgba(255,255,255,0.1);">
                        Expandir Todos
                    </button>
                </div>
            </div>
        </section>

        <!-- Sectors Grid -->
        <section class="sectors-grid" id="sectors-grid">
            <!-- Sector cards will be populated by JS -->
        </section>

    </div>

    <!-- Footer -->
    <footer class="footer">
        <p><strong>B3 SmallCaps</strong> Atualizado em Outubro 2025</p>
    </footer>

    <!-- Scripts -->
    <script src="data-companies.js"></script>
    <script src="utils.js"></script>
    <script>
        // ============================
        // SECTORS PAGE - SMART ENGINE
        // ============================

        let companiesData = [];
        let sectorData = {};
        let filteredSectors = [];

        // ============================
        // Initialization
        // ============================
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            analyzeSectors();
            renderStatsDashboard();
            renderSectors();
        });

        function loadData() {
            companiesData = COMPANIES_DATABASE || [];
            console.log(`✅ ${companiesData.length} empresas carregadas`);
        }

        function analyzeSectors() {
            sectorData = {};
            
            companiesData.forEach(company => {
                if (!sectorData[company.sector]) {
                    sectorData[company.sector] = {
                        name: company.sector,
                        companies: [],
                        metrics: {}
                    };
                }
                sectorData[company.sector].companies.push(company);
            });
            
            // Calculate sector metrics
            Object.keys(sectorData).forEach(sector => {
                const companies = sectorData[sector].companies;
                const validPE = companies.filter(c => c.metrics.pe > 0);
                
                sectorData[sector].metrics = {
                    count: companies.length,
                    avgScore: avg(companies.map(c => c.score)),
                    avgUpside: avg(companies.map(c => c.upside)),
                    avgROE: avg(companies.map(c => c.metrics.roe)),
                    avgPE: validPE.length > 0 ? avg(validPE.map(c => c.metrics.pe)) : 0,
                    avgMargin: avg(companies.map(c => c.metrics.ebitdaMargin)),
                    avgYTD: avg(companies.map(c => c.performance.ytd)),
                    totalMarketCap: sum(companies.map(c => c.marketCap)),
                    topScore: Math.max(...companies.map(c => c.score)),
                    topUpside: Math.max(...companies.map(c => c.upside))
                };
            });

            filteredSectors = Object.values(sectorData);
            console.log('✅ Análise setorial concluída', sectorData);
        }

        function avg(arr) {
            return arr.reduce((a, b) => a + b, 0) / arr.length;
        }

        function sum(arr) {
            return arr.reduce((a, b) => a + b, 0);
        }

        // ============================
        // Stats Dashboard
        // ============================
        function renderStatsDashboard() {
            const container = document.getElementById('stats-dashboard');
            const sectors = Object.values(sectorData);
            
            const totalCompanies = companiesData.length;
            const totalMarketCap = sum(sectors.map(s => s.metrics.totalMarketCap));
            const avgScore = avg(sectors.map(s => s.metrics.avgScore));
            const avgUpside = avg(sectors.map(s => s.metrics.avgUpside));
            const bestSector = sectors.sort((a, b) => b.metrics.avgScore - a.metrics.avgScore)[0];
            const bestPerformer = sectors.sort((a, b) => b.metrics.avgYTD - a.metrics.avgYTD)[0];

            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Setores</div>
                    <div class="stat-value">${sectors.length}</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Empresas Mapeadas</div>
                    <div class="stat-value">${totalCompanies}</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Market Cap Total</div>
                    <div class="stat-value">${formatLargeNumber(totalMarketCap)}</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Score Médio Global</div>
                    <div class="stat-value">${avgScore.toFixed(0)}</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Upside Médio</div>
                    <div class="stat-value" style="color: var(--success);">+${avgUpside.toFixed(1)}%</div>
                </div>
                
            `;
        }

        // ============================
        // Render Sectors
        // ============================
        function renderSectors() {
            const container = document.getElementById('sectors-grid');
            
            container.innerHTML = filteredSectors.map((sector, index) => {
                const companies = sector.companies.sort((a, b) => b.score - a.score);
                
                return `
                    <div class="sector-card" data-sector="${sector.name}">
                        <div class="sector-header" onclick="toggleSector(this)">
                            <div class="sector-title-group">
                                <div class="sector-name">${sector.name}</div>
                                <div class="sector-subtitle">${sector.metrics.count} empresas • Market Cap ${formatLargeNumber(sector.metrics.totalMarketCap)}</div>
                            </div>
                            
                            <div class="sector-metrics">
                                <div class="metric-box">
                                    <div class="metric-box-label">Score</div>
                                    <div class="metric-box-value">${sector.metrics.avgScore.toFixed(0)}</div>
                                </div>
                                
                                <div class="metric-box">
                                    <div class="metric-box-label">Upside</div>
                                    <div class="metric-box-value" style="color: var(--success);">+${sector.metrics.avgUpside.toFixed(0)}%</div>
                                </div>
                                
                                <div class="metric-box">
                                    <div class="metric-box-label">ROE</div>
                                    <div class="metric-box-value">${sector.metrics.avgROE.toFixed(0)}%</div>
                                </div>
                                
                                <div class="metric-box">
                                    <div class="metric-box-label">YTD</div>
                                    <div class="metric-box-value" style="color: ${sector.metrics.avgYTD > 0 ? 'var(--success)' : 'var(--danger)'};">
                                        ${sector.metrics.avgYTD > 0 ? '+' : ''}${sector.metrics.avgYTD.toFixed(0)}%
                                    </div>
                                </div>
                            </div>
                            
                            <div class="expand-icon">▼</div>
                        </div>
                        
                        <div class="sector-body">
                            <div class="sector-content">
                                
                                <!-- Stats Grid -->
                                <div class="sector-stats-grid">
                                    <div class="sector-stat-item">
                                        <div class="sector-stat-label">P/L Médio</div>
                                        <div class="sector-stat-value">${sector.metrics.avgPE.toFixed(1)}x</div>
                                    </div>
                                    <div class="sector-stat-item">
                                        <div class="sector-stat-label">Margem EBITDA</div>
                                        <div class="sector-stat-value">${sector.metrics.avgMargin.toFixed(1)}%</div>
                                    </div>
                                    <div class="sector-stat-item">
                                        <div class="sector-stat-label">Top Score</div>
                                        <div class="sector-stat-value">${sector.metrics.topScore}</div>
                                    </div>
                                    <div class="sector-stat-item">
                                        <div class="sector-stat-label">Top Upside</div>
                                        <div class="sector-stat-value" style="color: var(--success);">+${sector.metrics.topUpside.toFixed(0)}%</div>
                                    </div>
                                </div>

                                <!-- Companies Table -->
                                <div class="companies-table-container">
                                    <table class="companies-table">
                                        <thead>
                                            <tr>
                                                <th>Ranking</th>
                                                <th>Ticker</th>
                                                <th>Empresa</th>
                                                <th>Score</th>
                                                <th>Upside</th>
                                                <th>ROE</th>
                                                <th>P/L</th>
                                                <th>Recomendação</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${companies.map((company, idx) => `
                                                <tr>
                                                    <td>${idx + 1}</td>
                                                    <td class="ticker-cell">${company.ticker}</td>
                                                    <td>${company.name}</td>
                                                    <td>
                                                        <span class="score-badge ${getScoreClass(company.score)}">
                                                            ${company.score}
                                                        </span>
                                                    </td>
                                                    <td class="${company.upside > 0 ? 'upside-positive' : 'upside-negative'}">
                                                        ${company.upside > 0 ? '+' : ''}${company.upside.toFixed(1)}%
                                                    </td>
                                                    <td>${company.metrics.roe.toFixed(1)}%</td>
                                                    <td>${company.metrics.pe > 0 ? company.metrics.pe.toFixed(1) + 'x' : 'N/A'}</td>
                                                    <td style="font-size: 0.8em; font-weight: 600;">
                                                        ${company.recommendation}
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Chart Section -->
                                <div class="chart-section">
                                    <h4>Distribuição de Scores no Setor</h4>
                                    <div class="chart-container">
                                        <canvas id="chart-${index}"></canvas>
                                    </div>
                                </div>

                                <!-- Trends Section -->
                                <div class="trends-section">
                                    <h4>Catalisadores & Riscos</h4>
                                    <div class="trends-grid">
                                        <div class="trend-column positive">
                                            <h5>Catalisadores do Setor</h5>
                                            <ul>
                                                ${getSectorCatalysts(sector.name).map(c => `<li>${c}</li>`).join('')}
                                            </ul>
                                        </div>
                                        <div class="trend-column negative">
                                            <h5>Riscos do Setor</h5>
                                            <ul>
                                                ${getSectorRisks(sector.name).map(r => `<li>${r}</li>`).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Render charts after DOM update
            setTimeout(() => {
                filteredSectors.forEach((sector, index) => {
                    renderSectorChart(sector, index);
                });
            }, 100);
        }

        // ============================
        // Toggle Sector
        // ============================
        function toggleSector(header) {
            header.classList.toggle('active');
            const body = header.nextElementSibling;
            body.classList.toggle('expanded');
        }

        function expandAll() {
            const headers = document.querySelectorAll('.sector-header');
            const bodies = document.querySelectorAll('.sector-body');
            
            const isAnyExpanded = Array.from(bodies).some(b => b.classList.contains('expanded'));
            
            if (isAnyExpanded) {
                // Collapse all
                headers.forEach(h => h.classList.remove('active'));
                bodies.forEach(b => b.classList.remove('expanded'));
            } else {
                // Expand all
                headers.forEach(h => h.classList.add('active'));
                bodies.forEach(b => b.classList.add('expanded'));
            }
        }

        // ============================
        // Render Sector Chart
        // ============================
        function renderSectorChart(sector, index) {
            const canvas = document.getElementById(`chart-${index}`);
            if (!canvas) return;

            const companies = sector.companies.sort((a, b) => b.score - a.score);
            
            new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: companies.map(c => c.ticker),
                    datasets: [{
                        label: 'Score',
                        data: companies.map(c => c.score),
                        backgroundColor: companies.map(c => {
                            if (c.score >= 75) return '#00c853';
                            if (c.score >= 55) return '#ff9800';
                            return '#f44336';
                        }),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const company = companies[context.dataIndex];
                                    return [
                                        `Score: ${company.score}`,
                                        `Upside: +${company.upside.toFixed(1)}%`,
                                        `ROE: ${company.metrics.roe.toFixed(1)}%`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: 'rgba(255,255,255,0.7)' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'rgba(255,255,255,0.7)' }
                        }
                    }
                }
            });
        }

        // ============================
        // Filters
        // ============================
        function applyFilters() {
            const sortBy = document.getElementById('sort-by').value;
            const filterScore = document.getElementById('filter-score').value;
            const searchTerm = document.getElementById('search-sector').value.toLowerCase();

            // Filter
            filteredSectors = Object.values(sectorData).filter(sector => {
                // Search filter
                if (searchTerm && !sector.name.toLowerCase().includes(searchTerm)) {
                    return false;
                }

                // Score filter
                if (filterScore === 'high' && sector.metrics.avgScore <= 75) return false;
                if (filterScore === 'medium' && (sector.metrics.avgScore <= 55 || sector.metrics.avgScore > 75)) return false;
                if (filterScore === 'low' && sector.metrics.avgScore > 55) return false;

                return true;
            });

            // Sort
            filteredSectors.sort((a, b) => {
                const map = {
                    'score': (s) => s.metrics.avgScore,
                    'upside': (s) => s.metrics.avgUpside,
                    'roe': (s) => s.metrics.avgROE,
                    'ytd': (s) => s.metrics.avgYTD,
                    'companies': (s) => s.metrics.count
                };
                return map[sortBy](b) - map[sortBy](a);
            });

            renderSectors();
        }

        // ============================
        // Helper Functions
        // ============================
        function getScoreClass(score) {
            if (score >= 75) return 'score-high';
            if (score >= 55) return 'score-medium';
            return 'score-low';
        }

        function formatLargeNumber(value) {
            if (!value) return '-';
            if (value >= 1e9) return `R$ ${(value / 1e9).toFixed(2)}B`;
            if (value >= 1e6) return `R$ ${(value / 1e6).toFixed(2)}M`;
            return `R$ ${value.toFixed(0)}`;
        }

        function getSectorCatalysts(sectorName) {
            const catalysts = {
                'Construção Civil': [
                    'Renovação MCMV 2026 com orçamento ampliado',
                    'Queda da Selic projetada para 2026',
                    'Déficit habitacional de 8M unidades',
                    'Crédito imobiliário crescendo 15% aa'
                ],
                'Energia': [
                    'Demanda crescente por energia limpa',
                    'Leilões de transmissão regulares',
                    'Receita regulada previsível (RAP)',
                    'Expansão LATAM (Peru, Colômbia)'
                ],
                'Tecnologia': [
                    'Digitalização acelerada pós-pandemia',
                    'E-commerce crescimento estrutural',
                    'Fintech/cashback ganhando share',
                    'IA e automação'
                ],
                'Varejo': [
                    'Recuperação consumo classes C/D',
                    'Expansão omnichannel',
                    'Internacionalização (LATAM)',
                    'Programas fidelidade'
                ],
                'Agronegócio': [
                    'Demanda China por grãos e proteínas',
                    'Valorização de terras agrícolas',
                    'Tecnologia (agricultura de precisão)',
                    'Halal markets (MENA)'
                ],
                'Saúde': [
                    'Envelhecimento populacional',
                    'Incidência câncer crescendo',
                    'Consolidação do setor',
                    'Telemedicina e digital health'
                ]
            };
            return catalysts[sectorName] || ['Análise de catalisadores em desenvolvimento'];
        }

        function getSectorRisks(sectorName) {
            const risks = {
                'Construção Civil': [
                    'Sensibilidade à taxa de juros',
                    'Inflação de insumos (cimento, aço)',
                    'Aprovação de projetos (burocracia)',
                    'Ciclicalidade do setor'
                ],
                'Energia': [
                    'Risco regulatório ANEEL',
                    'Inadimplência distribuidoras',
                    'Capex intensivo',
                    'Risco hidrológico'
                ],
                'Tecnologia': [
                    'Competição intensa (BigTechs)',
                    'Ciclo de funding restrito',
                    'Regulação fintech aumentando',
                    'Volatilidade cambial'
                ],
                'Varejo': [
                    'Sensibilidade a desemprego',
                    'Competição e-commerce vs físico',
                    'Margens pressionadas',
                    'Inadimplência consumidor'
                ],
                'Agronegócio': [
                    'Volatilidade preços commodities',
                    'Clima (La Niña / El Niño)',
                    'Câmbio USD/BRL',
                    'Logística (portos, ferrovias)'
                ],
                'Saúde': [
                    'Regulação ANS',
                    'Sinistralidade planos',
                    'Custos médicos inflacionários',
                    'Competição hospitalar'
                ]
            };
            return risks[sectorName] || ['Análise de riscos em desenvolvimento'];
        }
    </script>
</body>
</html>